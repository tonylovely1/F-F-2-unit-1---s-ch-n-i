<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√°ch N√≥i Unit 1: Is this your mom?</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Thi·∫øt l·∫≠p font ch·ªØ Inter v√† n·ªÅn */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* M√†u n·ªÅn nh·∫π nh√†ng */
        }

        /* Th·∫ª hi·ªÉn th·ªã c√¢u hi·ªán t·∫°i */
        #current-sentence-card {
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
            cursor: pointer; /* Cho ph√©p click ƒë·ªÉ nghe l·∫°i */
        }

        .role-A-bg {
            background-color: #dbeafe; /* blue-100 */
        }
        .role-B-bg {
            background-color: #ede9fe; /* violet-100 */
        }
        
        .card-playing {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5);
            border: 3px solid #3b82f6;
        }

        .role-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            color: #4f46e5; /* indigo-600 */
            margin-bottom: 0.5rem;
        }

        .main-text {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800;
            color: #1f2937; /* gray-800 */
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji {
            font-size: 3rem;
            margin-right: 1rem;
        }

        /* Feedback Styles */
        .feedback-success { color: #10b981; } /* emerald-500 */
        .feedback-error { color: #ef4444; }   /* red-500 */
        .feedback-listening { color: #3b82f6; } /* blue-500 */
        .feedback-test { color: #ff9800; } /* orange-500 */

        /* Hi·ªáu ·ª©ng loading */
        .loading-dot {
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            to { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">
    <div id="app" class="w-full max-w-xl bg-white rounded-2xl shadow-2xl p-4 md:p-10 mt-4">

        <!-- Ti√™u ƒë·ªÅ (Bilingual) -->
        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 mb-2 text-center">
            S√°ch N√≥i Unit 1: Is this your mom?
        </h1>
        <p class="text-lg text-gray-600 mb-6 text-center border-b pb-4">
            Luy·ªán t·∫≠p v√† Ki·ªÉm tra M·∫´u c√¢u Gia ƒë√¨nh | Family Sentence Pattern Practice & Check
        </p>
        
        <!-- C·∫£nh b√°o d√†nh cho ng∆∞·ªùi d√πng -->
        <div class="p-4 mb-6 text-sm text-yellow-800 rounded-lg bg-yellow-50" role="alert">
            <span class="font-medium">L∆∞u √Ω QUAN TR·ªåNG:</span> Ch·ª©c nƒÉng **ƒê·ªåC** (Micro) ch·ªâ ho·∫°t ƒë·ªông tr√™n m√¥i tr∆∞·ªùng an to√†n (HTTPS/localhost).
            <div id="security-status" class="mt-2 font-bold">ƒêang ki·ªÉm tra m√¥i tr∆∞·ªùng...</div>
        </div>
        
        <!-- Khu v·ª±c TEST MICROPHONE m·ªõi -->
        <div id="mic-test-area" class="text-center mb-6">
            <button id="test-mic-button" onclick="testMicrophone()"
                class="px-5 py-2 bg-pink-500 text-white font-bold text-sm rounded-xl shadow-lg hover:bg-pink-600 transition duration-150 transform hover:scale-105 flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M4.2 11.75a.75.75 0 011.06 0A5.5 5.5 0 0010 16.5a5.5 5.5 0 004.74-2.75.75.75 0 111.33 0A7 7 0 0110 18a7 7 0 01-5.07-2.25.75.75 0 010-1.06z" clip-rule="evenodd" />
                </svg>
                TEST MICROPHONE
            </button>
            <p id="mic-test-status" class="mt-2 text-sm font-semibold text-gray-700">Nh·∫•n n√∫t tr√™n ƒë·ªÉ ki·ªÉm tra micro.</p>
        </div>


        <!-- Th·∫ª hi·ªÉn th·ªã c√¢u hi·ªán t·∫°i -->
        <div id="current-sentence-card" 
             onclick="repeatCurrentSentence()"
             class="role-A-bg mb-8">
            <p id="role-display" class="role-title">S·∫µn s√†ng h·ªçc | Ready to start</p>
            <div id="text-display" class="main-text">
                <span id="emoji-display" class="emoji">üìö</span>
                <span id="sentence-text-content">Nh·∫•n "B·∫ÆT ƒê·∫¶U" ƒë·ªÉ b·∫Øt ƒë·∫ßu!</span>
            </div>
        </div>
        
        <!-- Khu v·ª±c ph·∫£n h·ªìi ki·ªÉm tra gi·ªçng n√≥i -->
        <div id="feedback-display" class="text-center text-lg font-semibold mb-6">
            <!-- Ph·∫£n h·ªìi ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
        </div>


        <!-- N√∫t ƒëi·ªÅu khi·ªÉn Th·ª±c h√†nh (Nghe l·∫°i & ƒê·ªçc) -->
        <div id="practice-controls" class="flex justify-center space-x-4 mb-8">
            <button id="repeat-button" onclick="repeatCurrentSentence()" disabled
                class="px-5 py-3 bg-indigo-500 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-indigo-600 transition duration-150 transform hover:scale-105 disabled:opacity-50 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                NGHE L·∫†I
            </button>
            <button id="read-button" onclick="startRecognition()" disabled
                class="px-5 py-3 bg-yellow-500 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-yellow-600 transition duration-150 transform hover:scale-105 disabled:opacity-50 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-7-3v-2a3 3 0 016 0v2m2 5a2 2 0 01-2 2H7a2 2 0 01-2-2v-4a2 2 0 012-2h10a2 2 0 012 2v4z" />
                </svg>
                ƒê·ªåC
            </button>
        </div>
        
        <!-- N√∫t ƒëi·ªÅu khi·ªÉn Ch√≠nh (B·∫Øt ƒë·∫ßu/Ti·∫øp theo/D·ª´ng) -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="next-button" onclick="nextSentence()" disabled
                class="px-8 py-3 bg-green-600 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105 disabled:opacity-50 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 12h14" />
                </svg>
                <span id="start-text">B·∫ÆT ƒê·∫¶U | START</span>
            </button>
            <button id="stop-button" onclick="stopReading()" disabled
                class="px-8 py-3 bg-red-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-105 disabled:opacity-50">
                D·ª™NG | STOP
            </button>
        </div>
        
        <!-- Th√¥ng b√°o ƒêang t·∫£i (Ch·ªâ hi·ªÉn th·ªã l√∫c kh·ªüi t·∫°o voices) -->
        <div id="loading-indicator" class="text-center text-xl font-semibold text-indigo-500 mb-6 hidden">
            ƒêang t·∫£i d·ªØ li·ªáu gi·ªçng n√≥i... / Loading voice data...
            <span class="loading-dot inline-block w-2 h-2 bg-indigo-500 rounded-full mx-1"></span>
            <span class="loading-dot inline-block w-2 h-2 bg-indigo-500 rounded-full mx-1"></span>
            <span class="loading-dot inline-block w-2 h-2 bg-indigo-500 rounded-full mx-1"></span>
        </div>

    </div>

    <script>
        // --- C·∫§U H√åNH V√Ä D·ªÆ LI·ªÜU ---
        
        const scriptData = [
            // C·∫•u tr√∫c: role, text, voice (d√πng cho vi·ªác ch·ªçn gi·ªçng native), emoji
            { role: "Gi·ªçng A (h√†o h·ª©ng)", text: "Is this your mom?", voice: "male", emoji: "‚ùìüë©" },
            { role: "Gi·ªçng B (t·ª± tin)", text: "Yes, it is.", voice: "female", emoji: "‚úÖ" },
            
            { role: "Gi·ªçng A (t√≤ m√≤)", text: "Is this your dad?", voice: "male", emoji: "‚ùìüë®" },
            { role: "Gi·ªçng B (ch·∫Øc ch·∫Øn)", text: "No, it isn‚Äôt.", voice: "female", emoji: "‚ùå" },
            
            { role: "Gi·ªçng A (gi·ªõi thi·ªáu)", text: "This is my brother.", voice: "male", emoji: "üßç‚Äç‚ôÇÔ∏è" },
            
            { role: "Gi·ªçng A (h·ªèi)", text: "Is this your grandpa?", voice: "male", emoji: "‚ùìüë¥" },
            { role: "Gi·ªçng B (tr·∫£ l·ªùi ƒë·∫ßy ƒë·ªß)", text: "Yes, it is. This is my grandpa.", voice: "female", emoji: "‚úÖüë¥" },
            
            { role: "Gi·ªçng A (h·ªèi l·∫ßn cu·ªëi)", text: "Is this your sister?", voice: "male", emoji: "‚ùìüëß" },
            { role: "Gi·ªçng B (ch·ªëi v√† gi·ªõi thi·ªáu)", text: "No, it isn't. This is my grandma.", voice: "female", emoji: "‚ùåüëµ" },
        ];
        
        // --- DOM Elements ---
        const NEXT_BUTTON = document.getElementById('next-button');
        const STOP_BUTTON = document.getElementById('stop-button');
        const REPEAT_BUTTON = document.getElementById('repeat-button');
        const READ_BUTTON = document.getElementById('read-button');
        const LOADING_INDICATOR = document.getElementById('loading-indicator');
        const CARD = document.getElementById('current-sentence-card');
        const ROLE_DISPLAY = document.getElementById('role-display');
        const EMOJI_DISPLAY = document.getElementById('emoji-display');
        const TEXT_CONTENT = document.getElementById('sentence-text-content');
        const FEEDBACK_DISPLAY = document.getElementById('feedback-display');
        const SECURITY_STATUS = document.getElementById('security-status'); 
        const MIC_TEST_STATUS = document.getElementById('mic-test-status'); // New

        // --- State Variables ---
        let isStopped = true;
        let availableVoices = [];
        let currentLineIndex = -1; 
        let isSpeaking = false;
        let recognition; 
        
        // --- UTILITY FUNCTIONS ---

        /**
         * Chu·∫©n h√≥a vƒÉn b·∫£n: lo·∫°i b·ªè d·∫•u c√¢u v√† chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng.
         */
        function normalizeText(text) {
            return text.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g, "").trim();
        }

        /**
         * C·∫≠p nh·∫≠t ph·∫£n h·ªìi tr√™n m√†n h√¨nh.
         */
        function updateFeedback(message, type = 'default', target = FEEDBACK_DISPLAY) {
            target.textContent = message;
            target.classList.remove('feedback-success', 'feedback-error', 'feedback-listening', 'feedback-test', 'hidden');
            
            if (type === 'success') {
                target.classList.add('feedback-success');
            } else if (type === 'error') {
                target.classList.add('feedback-error');
            } else if (type === 'listening') {
                target.classList.add('feedback-listening');
            } else if (type === 'test') {
                 target.classList.add('feedback-test');
            } else {
                target.classList.add('hidden');
            }
        }

        // --- MICROPHONE TEST FUNCTION (D√πng ƒë·ªÉ ch·∫©n ƒëo√°n) ---
        /**
         * Ch·ª©c nƒÉng ƒë·ªôc l·∫≠p ki·ªÉm tra quy·ªÅn truy c·∫≠p micro c·ªßa tr√¨nh duy·ªát.
         */
        function testMicrophone() {
            console.log("--- TEST MICRO: B·∫Øt ƒë·∫ßu ch·∫°y testMicrophone() ---");
            updateFeedback('ƒêang ki·ªÉm tra quy·ªÅn Micro...', 'test', MIC_TEST_STATUS);
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error("TEST MICRO: L·ªói - Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Media Devices.");
                updateFeedback('L·ªói: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Media Devices.', 'error', MIC_TEST_STATUS);
                return;
            }

            try {
                console.log("TEST MICRO: G·ªçi navigator.mediaDevices.getUserMedia({ audio: true })...");
                
                // D√πng Promise ƒë·ªÉ ki·ªÉm tra quy·ªÅn
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        // Th√†nh c√¥ng: ƒê√£ c·∫•p quy·ªÅn
                        console.log("TEST MICRO: SUCCESS - ƒê√£ nh·∫≠n ƒë∆∞·ª£c stream.");
                        updateFeedback('‚úÖ MICROPHONE HO·∫†T ƒê·ªòNG! (K√≠ch ho·∫°t cho trang n√†y)', 'success', MIC_TEST_STATUS);
                        
                        // Quan tr·ªçng: D·ª´ng stream ngay l·∫≠p t·ª©c ƒë·ªÉ kh√¥ng chi·∫øm micro
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(error => {
                        // Th·∫•t b·∫°i: B·ªã t·ª´ ch·ªëi (NotAllowedError) ho·∫∑c l·ªói thi·∫øt b·ªã
                        console.error('TEST MICRO: FAILURE - L·ªói khi ki·ªÉm tra Microphone:', error.name, error.message);
                        
                        let errorMessage;
                        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                            errorMessage = '‚ùå MICRO B·ªä CH·∫∂N! Vui l√≤ng b·∫•m v√†o bi·ªÉu t∆∞·ª£ng ·ªî KH√ìA (üîí) tr√™n thanh ƒë·ªãa ch·ªâ v√† ch·ªçn "Cho ph√©p" (Allow) cho Micro.';
                        } else if (error.name === 'NotFoundError') {
                             errorMessage = '‚ùå L·ªñI THI·∫æT B·ªä: Kh√¥ng t√¨m th·∫•y Micro tr√™n h·ªá th·ªëng c·ªßa b·∫°n.';
                        } else if (error.name === 'AbortError') {
                             errorMessage = '‚ùå H·ªßy b·ªè: Y√™u c·∫ßu truy c·∫≠p Micro b·ªã h·ªßy b·ªè.';
                        } else {
                            errorMessage = `‚ùå L·ªñI KH√îNG X√ÅC ƒê·ªäNH (${error.name}). Ki·ªÉm tra ·ª©ng d·ª•ng kh√°c c√≥ ƒëang chi·∫øm Micro kh√¥ng.`;
                        }
                        updateFeedback(errorMessage, 'error', MIC_TEST_STATUS);
                    });
            } catch (e) {
                // B·∫Øt l·ªói ƒë·ªìng b·ªô (r·∫•t hi·∫øm)
                console.error('TEST MICRO: L·ªói ƒë·ªìng b·ªô khi g·ªçi getUserMedia:', e.name, e.message);
                updateFeedback(`L·ªói nghi√™m tr·ªçng (${e.name}): Vui l√≤ng ki·ªÉm tra l·∫°i tr√¨nh duy·ªát.`, 'error', MIC_TEST_STATUS);
            }
        }


        // --- NATIVE SPEECH SYNTHESIS (READING) FUNCTIONS ---

        /**
         * T·∫£i danh s√°ch gi·ªçng n√≥i sau khi ch√∫ng c√≥ s·∫µn.
         */
        function loadVoices() {
            availableVoices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
            if (availableVoices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    availableVoices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
                    if (availableVoices.length > 0) {
                        NEXT_BUTTON.disabled = false;
                        LOADING_INDICATOR.classList.add('hidden');
                    }
                };
            } else {
                NEXT_BUTTON.disabled = false;
                LOADING_INDICATOR.classList.add('hidden');
            }
        }

        /**
         * Ch·ªçn m·ªôt gi·ªçng n√≥i ph√π h·ª£p (∆Øu ti√™n gi·ªõi t√≠nh).
         */
        function selectVoice(genderHint) {
            let selectedVoice = null;
            
            if (availableVoices.length === 0) return null;

            // 1. T√¨m gi·ªçng ph√π h·ª£p v·ªõi gi·ªõi t√≠nh/t√™n ph·ªï bi·∫øn
            if (genderHint === 'male') {
                selectedVoice = availableVoices.find(v => v.name.toLowerCase().includes('male') || v.name.toLowerCase().includes('zira') || v.name.toLowerCase().includes('daniel'));
            } else if (genderHint === 'female') {
                selectedVoice = availableVoices.find(v => v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('ava') || v.name.toLowerCase().includes('samantha'));
            }
            
            // 2. N·∫øu kh√¥ng t√¨m th·∫•y, ch·ªçn gi·ªçng ti·∫øng Anh b·∫•t k·ª≥
            if (!selectedVoice) {
                selectedVoice = availableVoices[Math.floor(Math.random() * availableVoices.length)];
            }
            
            return selectedVoice;
        }

        /**
         * Ph√°t m·ªôt ƒëo·∫°n vƒÉn b·∫£n b·∫±ng gi·ªçng n√≥i Native.
         */
        function speakText(text, voice) {
            return new Promise(resolve => {
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                    isSpeaking = false;
                }
                
                CARD.classList.add('card-playing');
                isSpeaking = true;
                READ_BUTTON.disabled = true;

                const utterance = new SpeechSynthesisUtterance(text);
                const selectedVoice = selectVoice(voice);

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                utterance.rate = 0.75; 
                utterance.pitch = 1.0;
                
                utterance.onend = () => {
                    CARD.classList.remove('card-playing');
                    isSpeaking = false;
                    READ_BUTTON.disabled = false;
                    resolve();
                };
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    CARD.classList.remove('card-playing');
                    isSpeaking = false;
                    READ_BUTTON.disabled = false;
                    resolve(); 
                };

                window.speechSynthesis.speak(utterance);
            });
        }
        
        // --- NATIVE SPEECH RECOGNITION (CHECKING) FUNCTIONS ---

        /**
         * Kh·ªüi t·∫°o Speech Recognition API.
         */
        function initializeRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                READ_BUTTON.textContent = 'ƒê·ªåC (Kh√¥ng h·ªó tr·ª£)';
                READ_BUTTON.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false; // Nghe m·ªôt l·∫ßn
            recognition.interimResults = false; // Ch·ªâ tr·∫£ v·ªÅ k·∫øt qu·∫£ cu·ªëi c√πng
            recognition.lang = 'en-US'; // ƒê·∫∑t ng√¥n ng·ªØ nh·∫≠n d·∫°ng l√† Ti·∫øng Anh
        }

        /**
         * B·∫Øt ƒë·∫ßu nh·∫≠n d·∫°ng gi·ªçng n√≥i.
         */
        function startRecognition() {
            if (!recognition || currentLineIndex < 0 || currentLineIndex >= scriptData.length) {
                return; 
            }
            
            // D·ª´ng m·ªçi √¢m thanh ƒëang ph√°t
            window.speechSynthesis.cancel();

            // Th·ª≠ d·ª´ng tr∆∞·ªõc khi start.
            try {
                recognition.stop();
            } catch (e) {
                // B·ªè qua l·ªói n·∫øu kh√¥ng th·ªÉ d·ª´ng
            }
            
            // Thi·∫øt l·∫≠p tr·∫°ng th√°i
            READ_BUTTON.disabled = true;
            REPEAT_BUTTON.disabled = true;
            NEXT_BUTTON.disabled = true;
            CARD.classList.remove('card-playing');
            updateFeedback('ƒêang nghe... h√£y n√≥i c√¢u tr√™n. | Listening...', 'listening');

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                checkResult(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error, event); 
                let errorMessage;

                if (event.error === 'not-allowed') {
                    errorMessage = 'L·ªói: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p micro. (1) Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•p quy·ªÅn tr√™n tr√¨nh duy·ªát, (2) Ki·ªÉm tra c√†i ƒë·∫∑t Micro tr√™n h·ªá ƒëi·ªÅu h√†nh c·ªßa b·∫°n.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'L·ªói: Kh√¥ng ph√°t hi·ªán gi·ªçng n√≥i. Vui l√≤ng n√≥i to h∆°n.';
                } else {
                    errorMessage = `L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i: ${event.error}.`;
                }

                updateFeedback(errorMessage, 'error');
                READ_BUTTON.disabled = false;
                REPEAT_BUTTON.disabled = false;
            };

            recognition.onend = () => {
                if (NEXT_BUTTON.disabled) {
                    READ_BUTTON.disabled = false;
                    REPEAT_BUTTON.disabled = false;
                }
            };

            try {
                recognition.start();
            } catch (e) {
                console.error("L·ªói khi g·ªçi recognition.start():", e.name, e.message); 
                updateFeedback(`L·ªói kh·ªüi ƒë·ªông micro (${e.name}): Vui l√≤ng ƒë·∫£m b·∫£o Micro kh√¥ng b·ªã ·ª©ng d·ª•ng kh√°c s·ª≠ d·ª•ng.`, 'error');
                READ_BUTTON.disabled = false;
                REPEAT_BUTTON.disabled = false;
            }
        }
        
        /**
         * Ki·ªÉm tra k·∫øt qu·∫£ nh·∫≠n d·∫°ng so v·ªõi c√¢u mong mu·ªën b·∫±ng c√°ch so s√°nh t·ª´.
         * Ng∆∞·ª°ng ƒë·ªô kh√≥ ƒë√£ ƒë∆∞·ª£c gi·∫£m xu·ªëng 60% (MATCH_THRESHOLD = 0.60)
         */
        function checkResult(transcript) {
            const expectedText = scriptData[currentLineIndex].text;
            const normalizedTranscript = normalizeText(transcript);
            const normalizedExpected = normalizeText(expectedText);
            
            // T√°ch th√†nh c√°c t·ª´ (tokens)
            const expectedWords = normalizedExpected.split(/\s+/).filter(word => word.length > 0);
            const transcriptWords = normalizedTranscript.split(/\s+/).filter(word => word.length > 0);
            
            const expectedCount = expectedWords.length;
            
            if (expectedCount === 0) {
                updateFeedback('L·ªói: C√¢u m·∫´u tr·ªëng.', 'error');
                READ_BUTTON.disabled = false;
                REPEAT_BUTTON.disabled = false;
                return;
            }

            // D√πng m·ªôt b·∫£n sao c·ªßa transcriptWords ƒë·ªÉ theo d√µi c√°c t·ª´ ƒë√£ kh·ªõp
            let tempTranscriptWords = [...transcriptWords];
            let matchedWords = 0;

            // So s√°nh t·ª´ng t·ª´ trong c√¢u m·∫´u v·ªõi c√°c t·ª´ trong c√¢u c·ªßa h·ªçc sinh (kh√¥ng quan tr·ªçng th·ª© t·ª±)
            for (const expectedWord of expectedWords) {
                const matchIndex = tempTranscriptWords.findIndex(tWord => tWord === expectedWord);
                
                if (matchIndex !== -1) {
                    matchedWords++;
                    // Lo·∫°i b·ªè t·ª´ ƒë√£ kh·ªõp kh·ªèi m·∫£ng t·∫°m ƒë·ªÉ tr√°nh ƒë·∫øm tr√πng
                    tempTranscriptWords.splice(matchIndex, 1);
                }
            }

            // T√≠nh t·ª∑ l·ªá t·ª´ kh·ªõp (so v·ªõi s·ªë l∆∞·ª£ng t·ª´ mong mu·ªën)
            const matchRatio = matchedWords / expectedCount;
            const MATCH_THRESHOLD = 0.60; // Ng∆∞·ª°ng ƒë·ªô kh·ªõp 60%

            console.log("Expected Words:", expectedWords);
            console.log("Transcript Words (normalized):", transcriptWords);
            console.log("Matched Words:", matchedWords, "of", expectedCount);
            console.log("Match Ratio:", matchRatio);
            
            if (matchRatio >= MATCH_THRESHOLD) {
                updateFeedback(`Ch√≠nh x√°c! B·∫°n ƒë√£ ƒë·∫°t ${Math.round(matchRatio * 100)}% ƒë·ªô kh·ªõp. üéâ B·∫°n c√≥ th·ªÉ nh·∫•n TI·∫æP THEO.`, 'success');
                NEXT_BUTTON.disabled = false;
            } else {
                updateFeedback(`Th·ª≠ l·∫°i. B·∫°n n√≥i: "${transcript}". (ƒê·ªô kh·ªõp: ${Math.round(matchRatio * 100)}%). C√¢u ƒë√∫ng: "${expectedText}".`, 'error');
            }
            READ_BUTTON.disabled = false;
            REPEAT_BUTTON.disabled = false;
        }


        // --- MAIN LOGIC FUNCTIONS ---

        /**
         * C·∫≠p nh·∫≠t th·∫ª hi·ªÉn th·ªã v·ªõi d·ªØ li·ªáu c√¢u m·ªõi.
         */
        function updateCardDisplay(data) {
            ROLE_DISPLAY.textContent = data.role;
            EMOJI_DISPLAY.textContent = data.emoji;
            TEXT_CONTENT.textContent = data.text;

            // ƒê·ªïi m√†u n·ªÅn theo Role
            CARD.classList.remove('role-A-bg', 'role-B-bg');
            if (data.voice === 'male') {
                CARD.classList.add('role-A-bg');
            } else {
                CARD.classList.add('role-B-bg');
            }
        }
        
        /**
         * Chuy·ªÉn sang c√¢u ti·∫øp theo v√† ƒë·ªçc.
         */
        function nextSentence() {
            if (currentLineIndex >= 0 && !NEXT_BUTTON.disabled && NEXT_BUTTON.querySelector('span').textContent.includes('TI·∫æP THEO')) {
                 NEXT_BUTTON.disabled = true; 
            }
            
            isStopped = false;
            STOP_BUTTON.disabled = false;
            
            currentLineIndex++;
            
            if (currentLineIndex >= scriptData.length) {
                currentLineIndex = -1; // Reset
                stopReading(true); 
                return;
            }

            const currentItem = scriptData[currentLineIndex];
            
            // 1. C·∫≠p nh·∫≠t giao di·ªán
            updateCardDisplay(currentItem);
            updateFeedback(''); // X√≥a ph·∫£n h·ªìi c≈©
            
            // 2. V√¥ hi·ªáu h√≥a n√∫t NEXT v√† b·∫≠t n√∫t Nghe l·∫°i/ƒê·ªçc
            NEXT_BUTTON.disabled = true;
            REPEAT_BUTTON.disabled = false;
            READ_BUTTON.disabled = false;
            
            // 3. C·∫≠p nh·∫≠t n√∫t
            NEXT_BUTTON.querySelector('span').textContent = 'TI·∫æP THEO | NEXT';

            // 4. ƒê·ªçc c√¢u
            speakText(currentItem.text, currentItem.voice);
        }

        /**
         * L·∫∑p l·∫°i c√¢u hi·ªán t·∫°i (ƒë∆∞·ª£c g·ªçi khi click v√†o th·∫ª ho·∫∑c n√∫t Nghe L·∫°i).
         */
        function repeatCurrentSentence() {
            if (currentLineIndex >= 0 && currentLineIndex < scriptData.length) {
                const currentItem = scriptData[currentLineIndex];
                speakText(currentItem.text, currentItem.voice);
            }
        }

        /**
         * D·ª´ng ƒë·ªçc v√† reset.
         * @param {boolean} isFinished - True n·∫øu script ƒë√£ ho√†n th√†nh.
         */
        function stopReading(isFinished = false) {
            isStopped = true;
            window.speechSynthesis.cancel();
            if (recognition) recognition.stop(); 
            
            NEXT_BUTTON.disabled = false;
            STOP_BUTTON.disabled = true;
            REPEAT_BUTTON.disabled = true;
            READ_BUTTON.disabled = true;
            CARD.classList.remove('card-playing');
            isSpeaking = false;
            updateFeedback('');
            
            if (isFinished) {
                 NEXT_BUTTON.querySelector('span').textContent = 'HO√ÄN TH√ÄNH | FINISHED';
                 NEXT_BUTTON.disabled = true;
                 
                 // Thi·∫øt l·∫≠p l·∫°i th·∫ª hi·ªÉn th·ªã sau khi ho√†n th√†nh
                 ROLE_DISPLAY.textContent = 'ƒê√£ ho√†n th√†nh! | Finished!';
                 EMOJI_DISPLAY.textContent = 'üéâ';
                 TEXT_CONTENT.textContent = 'Nh·∫•n "B·∫ÆT ƒê·∫¶U L·∫†I" ƒë·ªÉ √¥n t·∫≠p.';

                 setTimeout(() => {
                    // Reset giao di·ªán sau 3 gi√¢y ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ b·∫Øt ƒë·∫ßu l·∫°i
                    NEXT_BUTTON.querySelector('span').textContent = 'B·∫ÆT ƒê·∫¶U L·∫†I | RESTART';
                    NEXT_BUTTON.disabled = false;
                    currentLineIndex = -1;
                    CARD.classList.remove('role-A-bg', 'role-B-bg');
                    CARD.classList.add('role-A-bg'); 
                 }, 3000);
            } else {
                // ƒêang d·ª´ng gi·ªØa ch·ª´ng
                NEXT_BUTTON.querySelector('span').textContent = 'TI·∫æP THEO | NEXT';
                
                if (currentLineIndex >= 0) {
                    REPEAT_BUTTON.disabled = false;
                    READ_BUTTON.disabled = false;
                    NEXT_BUTTON.disabled = true; 
                }
            }
        }


        // --- KH·ªûI T·∫†O ---
        
        function initializeApp() {
            // 0. Hi·ªÉn th·ªã tr·∫°ng th√°i b·∫£o m·∫≠t (Quan tr·ªçng ƒë·ªÉ ch·∫©n ƒëo√°n)
            if (window.isSecureContext) {
                SECURITY_STATUS.textContent = 'Tr·∫°ng th√°i b·∫£o m·∫≠t: ‚úÖ AN TO√ÄN (Micro c√≥ th·ªÉ ho·∫°t ƒë·ªông)';
                SECURITY_STATUS.classList.add('text-green-600');
            } else {
                SECURITY_STATUS.textContent = 'Tr·∫°ng th√°i b·∫£o m·∫≠t: ‚ùå KH√îNG AN TO√ÄN (Micro B·ªä CH·∫∂N)';
                SECURITY_STATUS.classList.add('text-red-600');
                READ_BUTTON.disabled = true;
            }
            
            // 1. Kh·ªüi t·∫°o Speech Synthesis (Gi·ªçng ƒë·ªçc)
            if ('speechSynthesis' in window) {
                NEXT_BUTTON.disabled = true; 
                STOP_BUTTON.disabled = true;
                REPEAT_BUTTON.disabled = true;
                LOADING_INDICATOR.classList.remove('hidden');
                loadVoices();
            } else {
                NEXT_BUTTON.textContent = "Kh√¥ng h·ªó tr·ª£ TTS | TTS Not Supported";
                NEXT_BUTTON.disabled = true;
                LOADING_INDICATOR.classList.add('hidden');
            }
            
            // 2. Kh·ªüi t·∫°o Speech Recognition (Ki·ªÉm tra gi·ªçng n√≥i)
            initializeRecognition();

            // 3. Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu cho th·∫ª
            currentLineIndex = -1;
            updateCardDisplay({
                role: 'S·∫µn s√†ng h·ªçc | Ready to start', 
                emoji: 'üìö', 
                text: 'Nh·∫•n "B·∫ÆT ƒê·∫¶U" ƒë·ªÉ b·∫Øt ƒë·∫ßu!', 
                voice: 'male'
            });
        }
        
        window.onload = initializeApp;
    </script>
</body>
</html>
